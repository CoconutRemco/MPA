{% extends "Mpapp/base_generic.html" %}
{% load static %}
{% load zip_filter %}

{% block content %}
<head>
  <link rel="stylesheet" type="text/css" href="{% static 'Mpapp/styles.css' %}">
</head>
  <h2>Jukebox</h2>

  <div class="song-list">
    <h2>All songs</h2>
    {% for song in songs %}
    <div class="song" data-id="{{ song.id }}">
        <img src="{{ song.image_url }}" alt="{{ song.title }}">
        <div class="song-info">
          <h3>{{ song.title }}</h3>
          <p>{{ song.artist }}</p>
         <a href="{{ song.spotify_url }}" class="button play-button" target="_blank">
          <span class="play-icon">&#9658;</span> <!-- This is a simple play icon -->
        </a>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="playlist">
    <h2>Playlists</h2>
    {% for playlist in playlists %}
      <div class="playlist-item">
        <h3>{{ playlist.name }}</h3>
        <p>{{ playlist.owner }}</p>
        <p>Songs:</p>
        <ul>
          {% for song in playlist.songs.all %}
            <li>{{ song.title }} by {{ song.artist }}</li>
          {% endfor %}
        </ul>
        <button class="update-playlist-button" data-id="{{ playlist.id }}">Update Playlist</button>
      </div>
    {% endfor %}
  </div>

  <button id="create-playlist" class="playlist-button">Add Playlist</button>  <!-- Add Playlist button -->

  <button id="get-playlists" class="playlist-button">Get Playlists</button>

  <!-- Add this modal to your jukebox.html template -->
  <div id="newPlaylistModal" class="modal" style="display: none;">
    <div class="modal-content">
      <form id="newPlaylistForm">
        <label for="songs">Selected Songs</label>
        <ul id="selectedSongs">
        </ul>

        <div id="playlistNameSection" style="display: none;">
          <label for="playlistName">Playlist Name</label>
          <input type="text" id="playlistName" name="playlistName" required>
          <button type="submit">Create Playlist</button>
          <button type="button" id="cancelPlaylist">Cancel</button> <!-- Cancel button -->
        </div>
      </form>
    </div>
  </div>

<script>
    var selectedSongs = [];
    var songElements = document.querySelectorAll('.song');

    function selectSong(songElement) {
      var songId = songElement.getAttribute('data-id');
      if (selectedSongs.includes(songId)) {
        // If the song is already selected, deselect it
        selectedSongs = selectedSongs.filter(id => id !== songId); // Remove the song from the array
        var songListItem = document.querySelector('#selectedSongs li[data-id="' + songId + '"]');
        songListItem.remove(); // Remove the song from the HTML list
        songElement.style.backgroundColor = ''; // Reset the background color
      } else {
        // If the song is not selected, select it
        selectedSongs.push(songId);
        var songTitle = songElement.querySelector('.song-info h3').textContent;
        document.getElementById('selectedSongs').innerHTML += '<li data-id="' + songId + '">' + songTitle + '</li>';
        songElement.style.backgroundColor = 'blue'; // Change the background color to blue
      }
    }
   document.getElementById('create-playlist').addEventListener('click', function() {
    document.getElementById('newPlaylistModal').style.display = 'block'; // Show the modal
    songElements.forEach(function(songElement) {
      songElement.addEventListener('click', function() {
        selectSong(this);
        document.getElementById('playlistNameSection').style.display = 'block'; // Show the playlist name input and submit button
      });
    });
  });

    document.getElementById('newPlaylistForm').addEventListener('submit', function(event) {
      event.preventDefault();
      var playlistName = document.getElementById('playlistName').value;
      fetch('/create_playlist/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          song_ids: selectedSongs,
          playlist_name: playlistName
        })
      }).then(function(response) {
        if (response.ok) {
          document.getElementById('newPlaylistModal').style.display = 'none';
          location.reload();
        } else {
          response.text().then(function(text) {
            console.log('Failed to create playlist:', text);
          });
          alert('Failed to create playlist');
        }
      }).catch(function(error) {
        console.log('Error during fetch:', error);
      });
    });

    document.getElementById('cancelPlaylist').addEventListener('click', function() {
      document.getElementById('newPlaylistModal').style.display = 'none'; // Hide the modal
    });

    document.getElementById('get-playlists').addEventListener('click', function() {
      fetch('/get_playlists/')
        .then(function(response) {
          if (response.ok) {
            response.json().then(function(playlists) {
              console.log('Playlists:', playlists);
            });
          } else {
            response.text().then(function(text) {
              console.log('Failed to get playlists:', text);
            });
          }
        })
        .catch(function(error) {
          console.log('Error during fetch:', error);
        });
    });
</script>
{% endblock %}
